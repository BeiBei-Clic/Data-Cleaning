import requests
import json
from typing import Dict, Any
from config import Config

class LLMClient:
    """å¤§æ¨¡å‹å®¢æˆ·ç«¯ï¼Œç”¨äºè°ƒç”¨OpenRouter APIè¿›è¡Œæ–‡æœ¬æ¸…æ´—"""
    
    def __init__(self, api_key: str = None, model: str = None):
        self.api_key = api_key or Config.OPENROUTER_API_KEY
        self.base_url = Config.OPENROUTER_BASE_URL
        self.model = model or Config.DEFAULT_MODEL
        
        if not self.api_key:
            raise ValueError("è¯·è®¾ç½®OPENROUTER_API_KEYç¯å¢ƒå˜é‡")
    
    def clean_text(self, text: str) -> str:
        """
        ä½¿ç”¨å¤§æ¨¡å‹æ¸…æ´—æ–‡æœ¬å¹¶æå–å…³é”®å­—ï¼Œè¿”å›æ ¼å¼åŒ–çš„ç»“æœ
        
        Args:
            text: éœ€è¦æ¸…æ´—çš„æ–‡æœ¬
            
        Returns:
            æ ¼å¼åŒ–çš„æ–‡æœ¬ï¼šåŸæ–‡ç‰‡æ®µ\n###å…³é”®è¯1 ###å…³é”®è¯2
        """
        prompt = self._create_cleaning_prompt(text)
        
        try:
            response = self._call_api(prompt)
            cleaned_text, keywords = self._parse_response(response)
            
            # ç»„åˆæˆæœ€ç»ˆæ ¼å¼ï¼šåŸæ–‡ç‰‡æ®µ\n###å…³é”®è¯1 ###å…³é”®è¯2
            if keywords:
                # å¤„ç†å…³é”®è¯æ ¼å¼ï¼Œç¡®ä¿æ¯ä¸ªå…³é”®è¯å‰éƒ½æœ‰###
                keyword_list = [kw.strip() for kw in keywords.replace('###', '').split(',') if kw.strip()]
                formatted_keywords = ' '.join([f"###{kw}" for kw in keyword_list])
                return f"{cleaned_text}\n{formatted_keywords}"
            else:
                return f"{cleaned_text}\n###å¤„ç†å¤±è´¥"
                
        except Exception as e:
            print(f"è°ƒç”¨å¤§æ¨¡å‹APIå¤±è´¥: {e}")
            # å¤±è´¥æ—¶è¿”å›åŸæ–‡æœ¬åŠ é»˜è®¤å…³é”®è¯
            return f"{text}\n###å¤„ç†å¤±è´¥"
    
    def _create_cleaning_prompt(self, text: str) -> str:
        """åˆ›å»ºæ¸…æ´—æ–‡æœ¬çš„æç¤ºè¯"""
        return f"""è¯·å¯¹ä»¥ä¸‹æ–‡æœ¬è¿›è¡Œæ¸…æ´—å’Œå…³é”®è¯æå–ã€‚

æ¸…æ´—è¦æ±‚ï¼š
1. ä¿æŒåŸè¯­è¨€ï¼Œä¸è¦ç¿»è¯‘
2. åˆ é™¤é¡µçœ‰é¡µè„šã€HTMLæ ‡ç­¾ã€å¤šä½™ç©ºç™½
3. ä¿®æ­£æ®µè½åˆ†å‰²ï¼Œæ¸…ç†ä¹±ç 
4. ä¿ç•™é‡è¦ä¿¡æ¯ã€æ•°æ®ã€åœ°åç­‰

å…³é”®è¯æå–è¦æ±‚ï¼š
- æå–8-12ä¸ªç›¸å…³å…³é”®è¯
- é‡ç‚¹å…³æ³¨ï¼šç»è¥æ¨¡å¼ã€äº§ä¸šç±»å‹ã€æŠ€æœ¯åº”ç”¨ã€æ”¿ç­–æªæ–½ç­‰
- ä¼˜å…ˆæå–ä¸“ä¸šæœ¯è¯­å’Œåœ°ç†æ ‡è¯†

ğŸŒŸ æˆåŠŸæ¡ˆä¾‹ç»´åº¦ï¼š
- **ç»è¥æ¨¡å¼**ï¼šå…šæ”¯éƒ¨+åˆä½œç¤¾ã€å…¬å¸+å†œæˆ·ã€å®¶åº­å†œåœºã€å†œæ°‘ä¸“ä¸šåˆä½œç¤¾ã€è‚¡ä»½åˆä½œåˆ¶
- **äº§ä¸šç±»å‹**ï¼šç‰¹è‰²ç§æ¤ã€ç”Ÿæ€å…»æ®–ã€ä¹¡æ‘æ—…æ¸¸ã€å†œäº§å“åŠ å·¥ã€ç”µå•†ç›´æ’­ã€æ–‡åˆ›äº§ä¸š
- **æŠ€æœ¯åº”ç”¨**ï¼šæ™ºæ…§å†œä¸šã€ç‰©è”ç½‘æŠ€æœ¯ã€æ— äººæœºæ¤ä¿ã€å†·é“¾ç‰©æµã€æ•°å­—åŒ–ç®¡ç†
- **ä¸»ä½“åä½œ**ï¼šå†œæˆ·å‚ä¸ã€ä¼ä¸šå¸¦åŠ¨ã€æ”¿åºœå¼•å¯¼ã€ç¤¾ä¼šèµ„æœ¬ã€ç§‘ç ”é™¢æ‰€åˆä½œ
- **å¸‚åœºæ¸ é“**ï¼šè®¢å•å†œä¸šã€å†œè¶…å¯¹æ¥ã€ç›´æ’­å¸¦è´§ã€å“ç‰Œå»ºè®¾ã€äº§é”€ä¸€ä½“åŒ–
- **æ•ˆç›ŠæŒ‡æ ‡**ï¼šå¢æ”¶è‡´å¯Œã€å°±ä¸šåˆ›é€ ã€äº§å€¼å¢é•¿ã€å“ç‰Œä»·å€¼ã€ç”Ÿæ€æ•ˆç›Š

âš ï¸ å¤±è´¥æ¡ˆä¾‹ç»´åº¦ï¼š
- **å¤±è´¥åŸå› **ï¼šèµ„é‡‘é“¾æ–­è£‚ã€æŠ€æœ¯ä¸è¶³ã€å¸‚åœºå®šä½é”™è¯¯ã€ç®¡ç†ä¸å–„ã€æ”¿ç­–ç†è§£åå·®
- **é£é™©å› ç´ **ï¼šå¸‚åœºæ³¢åŠ¨ã€è‡ªç„¶ç¾å®³ã€ç–«æƒ…å½±å“ã€ç«äº‰æ¿€çƒˆã€èµ„æºçŸ­ç¼º
- **é—®é¢˜è¡¨ç°**ï¼šäº§å“æ»é”€ã€åˆä½œç ´è£‚ã€ç¯å¢ƒæ±¡æŸ“ã€å†œæ°‘åˆ©ç›Šå—æŸã€å¯æŒç»­æ€§å·®
- **æ•´æ”¹æªæ–½**ï¼šæ”¿ç­–è°ƒæ•´ã€æ¨¡å¼ä¼˜åŒ–ã€æŠ€æœ¯å‡çº§ã€ç®¡ç†æ”¹è¿›ã€é£é™©é˜²æ§

ğŸ“„ æ”¿åºœæ–‡ä»¶å…³é”®è¯åˆ†ç±»ï¼š

ğŸ›ï¸ æ”¿ç­–è¦ç´ ï¼š
- **æ”¿ç­–åç§°**ï¼šä¹¡æ‘æŒ¯å…´ä¿ƒè¿›æ³•ã€å†œä¸šå†œæ‘ç°ä»£åŒ–è§„åˆ’ã€äº§ä¸šæ‰¶æŒæ”¿ç­–ã€åœŸåœ°åˆ¶åº¦æ”¹é©
- **å‘æ–‡å•ä½**ï¼šå†œä¸šå†œæ‘éƒ¨ã€å‘æ”¹å§”ã€è´¢æ”¿éƒ¨ã€è‡ªç„¶èµ„æºéƒ¨ã€çœå¸‚å¿æ”¿åºœ
- **æ—¶é—´è¦ç´ **ï¼šå®æ–½æœŸé™ã€é˜¶æ®µç›®æ ‡ã€æ—¶é—´èŠ‚ç‚¹ã€è€ƒæ ¸å‘¨æœŸ
- **é€‚ç”¨èŒƒå›´**ï¼šå…¨å›½æ€§ã€åŒºåŸŸæ€§ã€è¯•ç‚¹åœ°åŒºã€ç‰¹å®šäº§ä¸šã€ç‰¹æ®Šç¾¤ä½“

ğŸ¯ æ”¿ç­–æªæ–½ï¼š
- **èµ„é‡‘æ”¯æŒ**ï¼šä¸“é¡¹è¡¥è´´ã€ä½æ¯è´·æ¬¾ã€è´¢æ”¿å¥–åŠ±ã€ç¨æ”¶ä¼˜æƒ ã€ä¿é™©è¡¥è´´
- **åœŸåœ°æ”¿ç­–**ï¼šç”¨åœ°ä¿éšœã€æµè½¬æœºåˆ¶ã€ç¡®æƒç™»è®°ã€é›†ä½“å»ºè®¾ç”¨åœ°ã€å®…åŸºåœ°æ”¹é©
- **äººæ‰æ”¿ç­–**ï¼šäººæ‰å¼•è¿›ã€åŸ¹è®­è®¡åˆ’ã€åˆ›ä¸šæ‰¶æŒã€æŠ€æœ¯æŒ‡å¯¼ã€èŒä¸šæ•™è‚²
- **åŸºç¡€è®¾æ–½**ï¼šé“è·¯å»ºè®¾ã€æ°´åˆ©è®¾æ–½ã€ä¿¡æ¯ç½‘ç»œã€å…¬å…±æœåŠ¡ã€ç¯å¢ƒæ•´æ²»
- **ä¿éšœæœºåˆ¶**ï¼šè€ƒæ ¸è¯„ä¼°ã€ç›‘ç£é—®è´£ã€ç»©æ•ˆç®¡ç†ã€ä¿¡æ¯å…¬å¼€ã€ç¤¾ä¼šç›‘ç£

ğŸ” å…³é”®è¯æå–æŠ€å·§ï¼š
1. **ä¼˜å…ˆæå–ä¸“ä¸šæœ¯è¯­**ï¼šå¦‚"ä¸€æ‘ä¸€å“"ã€"ä¸‰äº§èåˆ"ã€"ç¾ä¸½ä¹¡æ‘"
2. **å…³æ³¨æ•°é‡è¯å’Œæ—¶é—´è¯**ï¼šå¦‚"2023-2025å¹´"ã€"å¢æ”¶30%"ã€"å¸¦åŠ¨500æˆ·"
3. **æå–åœ°ç†æ ‡è¯†**ï¼šå…·ä½“çš„çœå¸‚å¿æ‘åç§°ã€åœ°ç†ç‰¹å¾
4. **æ•è·åˆ›æ–°è¦ç´ **ï¼šæ–°æ¨¡å¼ã€æ–°æŠ€æœ¯ã€æ–°æœºåˆ¶çš„å…³é”®è¯
5. **è¯†åˆ«é—®é¢˜å¯¼å‘**ï¼šç—›ç‚¹ã€éš¾ç‚¹ã€å µç‚¹ç­‰é—®é¢˜å…³é”®è¯

ç»“åˆä¸Šé¢çš„æŒ‡å¯¼å’Œä½ è‡ªå·±çš„æ€è€ƒè¿›è¡Œæå–ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä¸Šé¢çš„å†…å®¹

è¯·ç›´æ¥è¾“å‡ºæ¸…æ´—åçš„æ–‡æœ¬å’Œå…³é”®è¯ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
æ¸…æ´—åæ–‡æœ¬ï¼š
[æ¸…æ´—åçš„æ–‡æœ¬å†…å®¹]
å…³é”®è¯ï¼š
[å…³é”®è¯1, å…³é”®è¯2, å…³é”®è¯3, ...]

åŸæ–‡æœ¬ï¼š
{text}
"""
    
    def _call_api(self, prompt: str) -> Dict[Any, Any]:
        """è°ƒç”¨OpenRouter API"""
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "https://github.com/your-repo",  # å¯é€‰
            "X-Title": "Data Cleaning Tool"  # å¯é€‰
        }
        
        data = {
            "model": self.model,
            "messages": [
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            "max_tokens": 4000,
            "temperature": 0.3
        }
        
        response = requests.post(
            f"{self.base_url}/chat/completions",
            headers=headers,
            json=data,
            timeout=60
        )
        
        if response.status_code != 200:
            raise Exception(f"APIè°ƒç”¨å¤±è´¥: {response.status_code} - {response.text}")
        
        return response.json()
    
    def _parse_response(self, response: Dict[Any, Any]) -> tuple[str, str]:
        """è§£æAPIå“åº”ï¼Œè¿”å›(æ¸…æ´—åæ–‡æœ¬, å…³é”®è¯)"""
        try:
            content = response['choices'][0]['message']['content']
            
            # è§£ææ¸…æ´—åçš„æ–‡æœ¬å’Œå…³é”®è¯
            if "æ¸…æ´—åæ–‡æœ¬ï¼š" in content and "å…³é”®è¯ï¼š" in content:
                parts = content.split("å…³é”®è¯ï¼š")
                cleaned_text = parts[0].replace("æ¸…æ´—åæ–‡æœ¬ï¼š", "").strip()
                keywords = parts[1].strip()
                
                # æ¸…ç†å¯èƒ½çš„"åŸæ–‡æœ¬ï¼š"éƒ¨åˆ†
                if "åŸæ–‡æœ¬ï¼š" in keywords:
                    keywords = keywords.split("åŸæ–‡æœ¬ï¼š")[0].strip()
                    
            else:
                # å¦‚æœæ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œè¿”å›åŸå§‹å†…å®¹
                cleaned_text = content
                keywords = ""
            
            return cleaned_text, keywords
            
        except (KeyError, IndexError) as e:
            raise Exception(f"è§£æAPIå“åº”å¤±è´¥: {e}")